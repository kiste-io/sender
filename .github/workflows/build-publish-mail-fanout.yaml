name: Build and publish mail-fanout app

on:
  push:
    paths:
      - "examples/mail-fanout/**"

defaults:
  run:
    shell: bash
    working-directory: examples/mail-fanout

jobs:
  build-and-publish:
    name: build, publish
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: Cache Node.js modules
      uses: actions/cache@v2
      with:
        path: ~/.npm
        key: ${{ runner.OS }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-
          ${{ runner.OS }}-

    - name: Install dependencies
      run: |
        npm install
        
    - name: Determine image tag based on the Git tag/branch
      id: metadata
      run: |
        REF_NAME=$(echo ${GITHUB_REF#refs/*/} | sed -e 's/^v//')
        TAG=$(printf $REF_NAME | tr -c '[[:alnum:]]._-' '_')
        if [[ "$REF_NAME" == "main" || "$REF_NAME" == "master" ]]; then TAG=latest; fi
        echo "::set-output name=tag::$TAG"

    - uses: docker/setup-buildx-action@v1

    - uses: docker/login-action@v1
      with:
        registry: docker.io
        username: kisteio
        password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

    - uses: docker/build-push-action@v2
      with:
        push: true
        tags: kisteio/mail-fanout:${{ steps.metadata.outputs.tag }}
